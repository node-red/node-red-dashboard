<style>
.nr-db-sb {
    position: absolute;
    top: 1px;
    bottom: 2px;
    left: 1px;
    right: 1px;
    overflow-y: scroll;
    padding: 10px;
}
.nr-db-sb .form-row label {
    display: block;
    width: auto;
}
.nr-db-sb .form-row input,
.nr-db-sb .form-row select {
    width: calc(100% - 20px);
    margin-bottom:0;
}
.nr-db-sb .red-ui-editableList-container {
    padding:0;
}
.nr-db-sb-tab-list li {
    padding: 0;
}
.nr-db-sb-tab-list-item {
    border-radius: 4px;
    color: #333;
}
.nr-db-sb-list-header {
    cursor: pointer;
    position:relative;
    color: #666;
    padding:3px;
    white-space: nowrap;
}
.nr-db-sb-list-header:hover {
    color: #333;
}
.nr-db-sb-tab-list-header {
    background: #f3f3f3;
    padding:5px;
}
.nr-db-sb-group-list-header:hover, .nr-db-sb-widget-list-header:hover {
    background: #f9f9f9;
}
.nr-db-sb-list-chevron {
    width: 15px;
    text-align: center;
    margin: 3px 5px 3px 5px;
}
.nr-db-sb-tab-list-item .red-ui-editableList-container {
    border-radius: 0;
    border: none;
}
.nr-db-sb-list-handle {
    vertical-align: top;
    opacity: 0;
    cursor: move;
}
.nr-db-sb-list-header:hover>.nr-db-sb-list-handle,
.nr-db-sb-list-header:hover>.nr-db-sb-list-header-button-group {
    opacity: 1;
}
.nr-db-sb-list-header-button-group {
    opacity: 0;
}
.nr-db-sb-list-handle  {
    color: #bbb;
    padding:5px;
}
.nr-db-sb-tab-list-header>.nr-db-sb-list-chevron  {
    margin-left: 0px;
}
.nr-db-sb-group-list-header>.nr-db-sb-list-chevron {
    margin-left: 20px
}
.nr-db-sb-group-list li {
    border-bottom-color: #eee;
}
.nr-db-sb-group-list>li.ui-sortable-helper {
    border-top: 1px solid #eee;
}
.nr-db-sb-group-list>li:last-child {
    border-bottom: none;
}
.nr-db-sb-widget-list>li {
    border: none !important;
}
.nr-db-sb-group-list>li>.red-ui-editableList-item-handle {
    left: 10px;
}
.nr-db-sb-list-button-group {
    position: absolute;
    right: 3px;
    top: 0px;
}
.nr-db-sb-list-header-button-group {
    position: absolute;
    right: 3px;
    top: 4px;
}
.nr-db-sb-list-header-button {
    margin-left: 5px;
}
.nr-db-sb li.ui-sortable-helper {
    opacity: 0.9;
}
.nr-db-sb-widget-icon {
    margin-left: 56px;
}
.nr-db-sb-icon {
    margin-right: 10px;
}
.nr-db-sb-link {
    display: inline-block;
    padding-left: 3px;
}
.nr-db-sb-link-title {

}
.nr-db-sb-link-url {
    font-size: 0.8em;
    color: #999;
}
</style>
<script type="text/javascript">
RED.nodes.registerType('ui_base',{
    category: 'config',
    defaults: {
        name: {value: ''},
        theme: {value: ''}
    },
    hasUsers: false,
    paletteLabel: 'Dashboard',
    label: function() { return this.name || 'Node-RED Dashboard'; },
    oneditprepare: function() {
    },
    onpaletteadd: function() {
        var globalDashboardNode = null;

        function ensureDashboardNode(createMissing) {
            if (globalDashboardNode !== null) {
                // Check if it has been deleted beneath us
                var n = RED.nodes.node(globalDashboardNode.id);
                if (n===null) {
                    globalDashboardNode = null;
                }
            }
            if (globalDashboardNode === null) {
                RED.nodes.eachConfig(function(n) {
                    if (globalDashboardNode === null && n.type === 'ui_base') {
                        globalDashboardNode = n;
                    }
                });
                if (globalDashboardNode === null && createMissing) {
                    globalDashboardNode = {
                        id: RED.nodes.id(),
                        _def: RED.nodes.getType("ui_base"),
                        type: "ui_base",
                        name: "Node-RED Dashboard",
                        theme: "theme-light",
                        url: '/ui',
                        users:[]
                    }
                    RED.nodes.add(globalDashboardNode);
                    RED.nodes.dirty(true);
                }
            }
        }
        var content = $("<div>").css({"position":"relative","height":"100%"});
        var mainContent = $("<div>",{class:"nr-db-sb"}).appendTo(content);

        var form = $('<form class="dialog-form">').appendTo(mainContent);

        var divTitle = $('<div>',{class:"form-row"}).appendTo(form);
        $('<label>').html('Title').appendTo(divTitle);
        $('<input type="text" id="nr-db-field-title">').val("Node-RED Dashboard").css("width","calc(100% - 65px)")
            .change(function() {
                if (!globalDashboardNode || globalDashboardNode.name !== $(this).val()) {
                    ensureDashboardNode(true);
                    globalDashboardNode.name = $(this).val();
                    RED.nodes.dirty(true);
                }
            })
            .appendTo(divTitle);

        $('<a href="#" class="editor-button" style="margin-left: 10px;"><i class="fa fa-external-link"></i></a>')
            .click(function(evt) {
                window.open(document.location.protocol+"//"+document.location.host+RED.settings.httpNodeRoot+"ui");
                evt.preventDefault();
            })
            .appendTo(divTitle);

        var divTheme = $('<div>',{class:"form-row"}).appendTo(form);
        $('<label>').html('Theme').appendTo(divTheme);
        $('<select id="nr-db-field-theme">'+
            '<option value="theme-light">Light (default)</option>'+
            '<option value="theme-dark">Dark</option>'+
            '</select>')
            .change(function() {
                if (!globalDashboardNode || globalDashboardNode.theme !== $(this).val()) {
                    ensureDashboardNode(true);
                    globalDashboardNode.theme = $(this).val();
                    RED.nodes.dirty(true);
                }
            })
            .appendTo(divTheme);

        var divTabs = $('<div>',{class:"form-row",style:"position:relative"}).appendTo(form);
        $('<label>').html('Tabs').appendTo(divTabs);

        var buttonGroup = $('<div>',{class:"nr-db-sb-list-button-group"}).appendTo(divTabs);
        $('<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-angle-double-up"></i></a>')
            .click(function(evt) {
                tabContainer.find(".nr-db-sb-group-list-container").slideUp().addClass('nr-db-sb-collapsed');
                tabContainer.find(".nr-db-sb-tab-list-header>.nr-db-sb-list-chevron").css({"transform":"rotate(-90deg)"});
                evt.preventDefault();
            })
            .appendTo(buttonGroup);
        $('<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-angle-double-down"></i></a>')
            .click(function(evt) {
                tabContainer.find(".nr-db-sb-group-list-container").slideDown().removeClass('nr-db-sb-collapsed');
                tabContainer.find(".nr-db-sb-tab-list-header>.nr-db-sb-list-chevron").css({"transform":""});
                evt.preventDefault();
            })
            .appendTo(buttonGroup);
        $('<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-plus"></i> tab</a>')
            .click(function(evt) {
                tabContainer.editableList('addItem',{});
                evt.preventDefault();
            })
            .appendTo(buttonGroup);

        var tabLists = {};
        var groupLists = {};
        var linkNodes = {};

        function titleToggle(id,content,chevron) {
            return function(evt) {
                if (content.is(":visible")) {
                    content.slideUp();
                    chevron.css({"transform":"rotate(-90deg)"});
                    content.addClass('nr-db-sb-collapsed');
                    listStates[id] = false;
                } else {
                    content.slideDown();
                    chevron.css({"transform":""});
                    content.removeClass('nr-db-sb-collapsed');
                    listStates[id] = true;
                }
            };
        }

        var tabContainer = $('<ol>',{class:"nr-db-sb-tab-list"}).css({"min-height":"200px","height":"350px"}).appendTo(divTabs).editableList({
            sortable:".nr-db-sb-tab-list-header",
            addButton: false,
            addItem: function(container,i,tab) {
                var newTab = false;
                if (!tab.node) {
                    tab.node = {
                        id: RED.nodes.id(),
                        _def: RED.nodes.getType("ui_tab"),
                        type: "ui_tab",
                        users: [],
                        order: i+1,
                        name: "Tab "+(i+1),
                        icon: "dashboard"
                    };
                    listElements[tab.node.id] = container;
                    RED.nodes.add(tab.node);
                    tab.groups = [];
                    RED.nodes.dirty(true);
                    newTab = true;
                }
                if (RED.nodes.hasOwnProperty('updateConfigNodeUsers')) {
                    RED.nodes.updateConfigNodeUsers(tab.node);
                }
                var tabNode = tab.node;
                container.addClass("nr-db-sb-tab-list-item");
                var titleRow = $('<div>',{class:"nr-db-sb-list-header nr-db-sb-tab-list-header"}).appendTo(container);
                $('<i class="nr-db-sb-list-handle nr-db-sb-tab-list-handle fa fa-bars"></i>').appendTo(titleRow);
                var chevron = $('<i class="fa fa-angle-down nr-db-sb-list-chevron">',{style:"width: 10px;"}).appendTo(titleRow);
                $('<i class="nr-db-sb-icon nr-db-sb-tab-icon fa fa-file-o"></i>').appendTo(titleRow);
                var title = $('<span class="nr-db-sb-title">').html(tabNode.name||"").appendTo(titleRow);
                listElements[tabNode.id] = container;
                var buttonGroup = $('<div>',{class:"nr-db-sb-list-header-button-group"}).appendTo(titleRow);
                var addGroupButton = $('<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-plus"></i> group</a>').appendTo(buttonGroup);
                var editButton = $('<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-pencil"></i> edit</a>').appendTo(buttonGroup);

                var content = $('<div>',{class:"nr-db-sb-group-list-container"}).appendTo(container);

                if (listStates.hasOwnProperty(tabNode.id) && !listStates[tabNode.id]) {
                    content.hide();
                    chevron.css({"transform":"rotate(-90deg)"});
                    content.addClass('nr-db-sb-collapsed');
                    listStates[tabNode.id] = false;
                } else {
                    listStates[tabNode.id] = true;
                }
                setTimeout(function() {
                    chevron.css({"transition": "transform 0.2s ease-in-out"});
                },0);
                var ol = $('<ol>',{class:"nr-db-sb-group-list"}).appendTo(content).editableList({
                    sortable:".nr-db-sb-group-list-header",
                    addButton: false,
                    height: 'auto',
                    connectWith: ".nr-db-sb-group-list",
                    addItem: function(container,i,group) {
                        if (!group.node) {
                            group.node = {
                                id: RED.nodes.id(),
                                _def: RED.nodes.getType("ui_group"),
                                type: "ui_group",
                                users: [],
                                tab: tabNode.id,
                                order: i+1,
                                name: "Group "+(i+1),
                                width: 6,
                                disp: true
                            };
                            listElements[group.node.id] = container;
                            RED.nodes.add(group.node);
                            group.widgets = [];
                            RED.nodes.dirty(true);
                            if (RED.nodes.hasOwnProperty('updateConfigNodeUsers')) {
                                RED.nodes.updateConfigNodeUsers(group.node);
                            }

                        }
                        var groupNode = group.node;
                        elementParents[groupNode] = tabNode.id;

                        var titleRow = $('<div>',{class:"nr-db-sb-list-header nr-db-sb-group-list-header"}).appendTo(container);
                        $('<i class="nr-db-sb-list-handle nr-db-sb-group-list-handle fa fa-bars"></i>').appendTo(titleRow);
                        var chevron = $('<i class="fa fa-angle-down nr-db-sb-list-chevron">',{style:"width: 10px;"}).appendTo(titleRow);
                        $('<i class="nr-db-sb-icon nr-db-sb-group-icon fa fa-table"></i>').appendTo(titleRow);
                        var title = $('<span class="nr-db-sb-title">').html(groupNode.name||groupNode.id||"").appendTo(titleRow);
                        listElements[groupNode.id] = container;
                        var buttonGroup = $('<div>',{class:"nr-db-sb-list-header-button-group"}).appendTo(titleRow);
                        var editButton = $('<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-pencil"></i> edit</a>').appendTo(buttonGroup);

                        var content = $('<div>',{class:"nr-db-sb-widget-list-container"}).appendTo(container);
                        if (!listStates.hasOwnProperty(groupNode.id) || !listStates[groupNode.id]) {
                            content.hide();
                            chevron.css({"transform":"rotate(-90deg)"});
                            content.addClass('nr-db-sb-collapsed');
                            listStates[groupNode.id] = false;
                        } else {
                            listStates[groupNode.id] = true;
                        }
                        setTimeout(function() {
                            chevron.css({"transition": "transform 0.2s ease-in-out"});
                        },0);
                        var ol = $('<ol>',{class:"nr-db-sb-widget-list"}).appendTo(content).editableList({
                            sortable:".nr-db-sb-widget-list-header",
                            addButton: false,
                            height: 'auto',
                            connectWith: ".nr-db-sb-widget-list",
                            addItem: function(container,i,widgetNode) {
                                elementParents[widgetNode.id] = groupNode.id;
                                var titleRow = $('<div>',{class:"nr-db-sb-list-header nr-db-sb-widget-list-header"}).appendTo(container);
                                $('<i class="nr-db-sb-list-handle nr-db-sb-widget-list-handle fa fa-bars"></i>').appendTo(titleRow);
                                $('<i class="nr-db-sb-icon nr-db-sb-widget-icon fa fa-picture-o"></i>').appendTo(titleRow);
                                var l = widgetNode._def.label;
                                try {
                                    l = (typeof l === "function" ? l.call(widgetNode) : l)||"";
                                } catch(err) {
                                    console.log("Definition error: "+d.type+".label",err);
                                    l = d.type;
                                }
                                var title = $('<span class="nr-db-sb-title">').html(l).appendTo(titleRow);
                                listElements[widgetNode.id] = container;
                                var buttonGroup = $('<div>',{class:"nr-db-sb-list-header-button-group"}).appendTo(titleRow);
                                var editButton = $('<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-pencil"></i> edit</a>').appendTo(buttonGroup);
                                container.on('mouseover',function() {
                                    widgetNode.highlighted = true;
                                    widgetNode.dirty = true;
                                    RED.view.redraw();
                                });
                                container.on('mouseout',function() {
                                    widgetNode.highlighted = false;
                                    widgetNode.dirty = true;
                                    RED.view.redraw();
                                });
                                editButton.on('click',function(evt) {
                                    RED.editor.edit(widgetNode);
                                    evt.stopPropagation();
                                    evt.preventDefault();
                                });
                            },
                            sortItems: function(items) {
                                items.each(function(i,el) {
                                    var node = el.data('data');
                                    var changed = false;
                                    if (node.order !== i+1) {
                                        node.order = i+1;
                                        changed = true;
                                    }
                                    if (node.group !== group.node.id) {

                                        var oldGroupNode = RED.nodes.node(node.group);
                                        if (oldGroupNode) {
                                            var index = oldGroupNode.users.indexOf(node);
                                            oldGroupNode.users.splice(index,1);
                                        }
                                        node.group = group.node.id;
                                        group.node.users.push(node);
                                        changed = true;
                                    }
                                    if (changed) {
                                        node.dirty = true;
                                        node.changed = true;
                                    }
                                })
                                RED.nodes.dirty(true);
                                RED.view.redraw();
                            }
                        });
                        ol.css("min-height","5px");
                        if (groupNode.id) {
                            groupLists[groupNode.id] = ol;
                        }
                        titleRow.click(titleToggle(groupNode.id,content,chevron));
                        editButton.on('click',function(evt) {
                            RED.editor.editConfig("", groupNode.type, groupNode.id);
                            evt.stopPropagation();
                            evt.preventDefault();
                        });
                        group.widgets.forEach(function(widget) {
                            ol.editableList('addItem',widget);
                        })
                    },
                    sortItems: function(items) {
                        items.each(function(i,el) {
                            var groupData = el.data('data');
                            var node = groupData.node;
                            var changed = false;
                            if (node.order !== i+1) {
                                node.order = i+1;
                                changed = true;
                            }
                            if (changed) {
                                node.dirty = true;
                                node.changed = true;
                            }
                            if (node.tab !== tabNode.id) {
                                var oldTabNode = RED.nodes.node(node.tab);
                                if (oldTabNode) {
                                    var index = oldTabNode.users.indexOf(node);
                                    oldTabNode.users.splice(index,1);
                                }
                                node.tab = tabNode.id;
                                tabNode.users.push(node);
                                changed = true;
                            }
                        })
                        RED.nodes.dirty(true);
                        RED.view.redraw();
                    }
                });
                ol.css("min-height","10px");

                if (tabNode.id) {
                    tabLists[tabNode.id] = ol;
                }
                titleRow.click(titleToggle(tabNode.id,content,chevron));
                editButton.on('click',function(evt) {
                    RED.editor.editConfig("", tabNode.type, tabNode.id);
                    evt.stopPropagation();
                    evt.preventDefault();
                });
                addGroupButton.click(function(evt) {
                    ol.editableList('addItem',{});
                    evt.stopPropagation();
                    evt.preventDefault();
                });
                tab.groups.forEach(function(group) {
                    ol.editableList('addItem',group);
                });
            },
            sortItems: function(items) {
                items.each(function(i,el) {
                    var tabData = el.data('data');
                    var node = tabData.node;
                    var changed = false;
                    if (node.order !== i+1) {
                        node.order = i+1;
                        changed = true;
                    }
                    if (changed) {
                        node.dirty = true;
                        node.changed = true;
                    }
                })
                RED.nodes.dirty(true);
                RED.view.redraw();
            }
        });

        var orphanedWidgets = $('<div>',{class:"form-row"}).appendTo(form);
        $('<span><i class="fa fa-info-circle"></i> There <span id="nr-db-missing-group-count"></span> not in a group. Click <a id="nr-db-add-missing-groups" href="#">here</a> to create the missing groups</span>').appendTo(orphanedWidgets);
        orphanedWidgets.find('a').click(function(event) {
            var unknownGroups = {};
            RED.nodes.eachNode(function(node) {
                console.log("TYPE",node.type);
                if (/^ui_/.test(node.type) && node.type !== 'ui_link' && node.type !== 'ui_toast' && node.type !== 'ui_ui_control') {
                    if (!RED.nodes.node(node.group)) {
                        var g = node.group || "_BLANK_";
                        unknownGroups[g] = unknownGroups[g] || [];
                        unknownGroups[g].push(node);
                    }
                }
            });
            var tab = null;
            var tabs = tabContainer.editableList('items');
            tabs.first().each(function(i,el) {
                var tabData = el.data('data');
                tab = tabData.node;
            });

            if (tab === null) {
                tab = {
                    id: RED.nodes.id(),
                    _def: RED.nodes.getType("ui_tab"),
                    type: "ui_tab",
                    users: [],
                    order: 0,
                    name: "Tab",
                    icon: "dashboard"
                };
                RED.nodes.add(tab);
            }
            for (var groupId in unknownGroups) {
                if (unknownGroups.hasOwnProperty(groupId)) {
                    var groupNode = {
                        id: RED.nodes.id(),
                        _def: RED.nodes.getType("ui_group"),
                        type: "ui_group",
                        users: [],
                        tab: tab.id,
                        order: i+1,
                        name: (groupId==="_BLANK_"?"Group":groupId),
                        width: 6,
                        disp: true
                    };
                    RED.nodes.add(groupNode);
                    RED.editor.validateNode(groupNode);
                    if (RED.nodes.hasOwnProperty('updateConfigNodeUsers')) {
                        RED.nodes.updateConfigNodeUsers(groupNode);
                    }
                    var widgets = unknownGroups[groupId];
                    for (var i=0;i<widgets.length;i++) {
                        widgets[i].group = groupNode.id;
                        widgets[i].changed = true;
                        widgets[i].dirty = true;
                        if (RED.nodes.hasOwnProperty('updateConfigNodeUsers')) {
                            RED.nodes.updateConfigNodeUsers(widgets[i]);
                        }
                        RED.editor.validateNode(widgets[i]);
                    }
                }
            }
            RED.nodes.dirty(true);
            refresh();
            refreshOrphanedWidgets();
            RED.view.redraw();
            event.preventDefault();
        });

        var divLinks = $('<div>',{class:"form-row",style:"position:relative"}).appendTo(form);
        $('<label>').html('Menu links').appendTo(divLinks);

        buttonGroup = $('<div>',{class:"nr-db-sb-list-button-group"}).appendTo(divLinks);
        $('<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-plus"></i> link</a>')
            .click(function(evt) {
                linksContainer.editableList('addItem',{});
                evt.preventDefault();
            })
            .appendTo(buttonGroup);


        var linksContainer = $('<ol>',{class:"nr-db-sb-tab-list"}).css("height","150px").appendTo(divLinks).editableList({
            sortable: ".nr-db-sb-list-header",
            addButton: false,
            addItem: function(container,i,link) {
                if (!link.node) {
                    link.node = {
                        id: RED.nodes.id(),
                        _def: RED.nodes.getType("ui_link"),
                        type: "ui_link",
                        users: [],
                        order: i+1,
                        icon: 'open_in_browser',
                        target: 'newtab'
                    }
                    RED.nodes.add(link.node);
                    RED.nodes.dirty(true);
                }
                var linkNode = link.node;
                linkNodes[linkNode.id] = container;
                var titleRow = $('<div>',{class:"nr-db-sb-list-header"}).appendTo(container);
                $('<i class="nr-db-sb-list-handle fa fa-bars"></i>').appendTo(titleRow);
                var title = $('<div class="nr-db-sb-link">').appendTo(titleRow);
                $('<div class="nr-db-sb-link-name">').html(link.node.name||"untitled").appendTo(title);
                $('<div class="nr-db-sb-link-url">').html(link.node.link||"http://").appendTo(title);
                var buttonGroup = $('<div>',{class:"nr-db-sb-list-header-button-group"}).appendTo(titleRow);
                var editButton = $('<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-pencil"></i> edit</a>').appendTo(buttonGroup);
                editButton.on('click',function(evt) {
                    RED.editor.editConfig("", "ui_link", link.node.id);
                    evt.stopPropagation();
                    evt.preventDefault();
                });
            },
            sortItems: function(items) {
                items.each(function(i,el) {
                    var node = el.data('data');
                    var changed = false;
                    if (node.node.order !== i+1) {
                        node.node.order = i+1;
                        changed = true;
                    }
                    if (changed) {
                        node.node.dirty = true;
                        node.node.changed = true;
                    }
                })
                RED.nodes.dirty(true);
                RED.view.redraw();
            }
        });

        var listElements = {};
        var dashboard = [];
        var listStates = {};
        var elementParents = {};
        var awaitingGroups = {};
        var awaitingTabs = {};

        function getCurrentList() {
            var currentList = [];
            var tabs = tabContainer.editableList('items');
            var open = false;
            tabs.each(function(i,el) {
                var tabData = el.data('data');
                var tab = [];
                var groups = el.find('.nr-db-sb-group-list').editableList('items');
                groups.each(function(j,el) {
                    var group = [];
                    var groupData = el.data('data');
                    var widgets = el.find('.nr-db-sb-widget-list').editableList('items');
                    widgets.each(function(k,el) {
                        var widgetData = el.data('data');
                        group.push(widgetData.id);
                    })
                    tab.push({id:groupData.node.id, widgets:group});
                });
                currentList.push({id:tabData.node.id,groups:tab});
            });
            return currentList;
        }
        function refreshOrphanedWidgets() {
            var unknownGroups = {};
            var count = 0;
            RED.nodes.eachNode(function(node) {
                if (/^ui_/.test(node.type) && node.type !== 'ui_link' && node.type !== 'ui_toast' && node.type !== 'ui_ui_control') {
                    if (!RED.nodes.node(node.group)) {
                        var g = node.group || "_BLANK_";
                        unknownGroups[g] = unknownGroups[g] || [];
                        unknownGroups[g].push(node);
                        count++;
                    }
                }
            });

            if (count > 0) {
                orphanedWidgets.show();
                $("#nr-db-missing-group-count").text((count===1?"is ":"are ")+count+" widget"+(count === 1?"":"s"))
            } else {
                orphanedWidgets.hide();
            }
        }

        function refresh() {
            var currentList = getCurrentList();
            dashboard = [];
            var tabs = {};
            var groups = {};
            var elements = [];
            var groupElements = {};
            var tabGroups = {};
            var groupId;
            var group;
            var tabId;
            var tab;
            var links = [];

            var unknownGroups = 0;

            // Find all the tabs and groups
            RED.nodes.eachConfig(function(node) {
                if (node.type === 'ui_tab') {
                    tabs[node.id] = node;
                    //tabContainer.editableList('addItem',node);
                } else if (node.type === 'ui_group') {
                    groups[node.id] = node;
                } else if (node.type === 'ui_link') {
                    links.push(node);
                }
            });

            for (groupId in groups) {
                if (groups.hasOwnProperty(groupId)) {
                    group = groups[groupId];
                    if (tabs.hasOwnProperty(group.tab)) {
                        // This group belongs to a tab
                        tabGroups[group.tab] = tabGroups[group.tab]||[];
                        tabGroups[group.tab].push(group);
                    } else {
                        unknownGroups++;
                    }
                }
            }

            // Find all ui widgets - list them by their group id
            RED.nodes.eachNode(function(node) {
                if (/^ui_/.test(node.type)) {
                    if (groups.hasOwnProperty(node.group)) {
                        groupElements[node.group] = groupElements[node.group]||[];
                        groupElements[node.group].push(node);
                    } else if (node.type === 'ui_link') {
                        links.push(node);
                    } else if ((node.type !== 'ui_toast')&&(node.type !== 'ui_ui_control')) {
                        unknownGroups++;
                    }
                }
            });

            if (unknownGroups > 0) {
                $("#nr-db-missing-group-count").text((unknownGroups===1?"is ":"are ")+unknownGroups+" widget"+(unknownGroups === 1?"":"s"))
                orphanedWidgets.show();
            } else {
                orphanedWidgets.hide();
            }

            // Sort each group's array of widgets
            for (groupId in groupElements) {
                if (groupElements.hasOwnProperty(groupId)) {
                    group = groupElements[groupId];
                    groupElements[groupId] = group.map(function(v,i) { return {n:v,i:i} }).sort(function(A,B) {
                        if (A.n.order < B.n.order) { return A.n.order!==0?-1:1;}
                        if (A.n.order > B.n.order) { return B.n.order!==0?1:-1;}
                        return A.i - B.i;
                    }).map(function(v) { return v.n})
                }
            }
            // Sort each tabs's array of groups
            for (tabId in tabGroups) {
                if (tabGroups.hasOwnProperty(tabId)) {
                    tab = tabGroups[tabId];
                    tabGroups[tabId] = tab.map(function(v,i) { return {n:v,i:i} }).sort(function(A,B) {
                        if (A.n.order < B.n.order) { return -1;}
                        if (A.n.order > B.n.order) { return 1;}
                        return A.i - B.i;
                    }).map(function(v) { return v.n})
                }
            }
            var tabIds = Object.keys(tabs).map(function(v,i) { return {n:tabs[v],i:i} }).sort(function(A,B) {
                if (A.n.order < B.n.order) { return -1;}
                if (A.n.order > B.n.order) { return 1;}
                return A.i - B.i;
            }).map(function(v) { return v.n.id});
            tabIds.forEach(function(tabId) {
                var tab = {node:tabs[tabId],groups:[]};
                if (tabGroups[tabId]) {
                    tabGroups[tabId].forEach(function(groupNode) {
                        var group = {node: groupNode,widgets:[]};
                        if (groupElements[groupNode.id]) {
                            group.widgets = groupElements[groupNode.id];
                        }
                        tab.groups.push(group);
                    });
                }
                dashboard.push(tab);
            });
            var newList = dashboard.map(function(t) {
                return {
                    id: t.node.id,
                    groups: t.groups.map(function(g) {
                        return {
                            id: g.node.id,
                            widgets: g.widgets.map(function(w) {
                                return w.id;
                            })
                        }
                    })
                }
            });
            if (JSON.stringify(newList)!=JSON.stringify(currentList)) {
                listElements = {};
                groupLists = {};
                tabLists = {};
                tabs = {};
                groups = {};
                elementParents = {};
                tabContainer.empty();
                dashboard.forEach(function(tab) {
                    tabContainer.editableList('addItem',tab);
                });
            }

            links.sort(function(A,B) {
                return A.order - B.order;
            });

            links.forEach(function(link) {
                if (linkNodes[link.id]) {
                    var container = linkNodes[link.id];
                    container.find(".nr-db-sb-link-name").html(link.name||"untitled");
                    container.find(".nr-db-sb-link-url").html(link.link||"http://");
                } else {
                    linksContainer.editableList('addItem',{node:link});
                }
            });
            ensureDashboardNode();
            if (globalDashboardNode) {
                $("#nr-db-field-title").val(globalDashboardNode.name);
                $("#nr-db-field-theme").val(globalDashboardNode.theme);
                // $("#nr-db-field-url").val(globalDashboardNode.url);
            }
            awaitingGroups = {};
            awaitingTabs = {};
        }
        RED.sidebar.addTab({
            id: "dashboard",
            label: "dashboard",
            name: "Dashboard",
            content: content,
            closeable: true,
            disableOnEdit: true,
            onchange: function() { refresh(); }
        });

        RED.events.on("editor:save",function(node) {
            if (/^ui_/.test(node.type)) {
                if (node.type === "ui_tab" || node.type === "ui_group") {
                    if (listElements[node.id]) {
                        // Existing element
                        listElements[node.id].children(".nr-db-sb-list-header").find(".nr-db-sb-title").html(node.name||node.id);
                        if (node.type === "ui_group") {
                            refresh();
                        }
                    } else if (node.type === "ui_tab") {
                        // Adding a tab
                        tabContainer.editableList('addItem',{node:node,groups:[]})
                    } else {
                        // Adding a group
                        if (tabLists[node.tab]) {
                            tabLists[node.tab].editableList('addItem',{node:node,widgets:[]})
                        }
                    }
                } else if (node.type === "ui_link") {
                    if (linkNodes[node.id]) {
                        var container = linkNodes[node.id];
                        container.find(".nr-db-sb-link-name").html(node.name||"untitled");
                        container.find(".nr-db-sb-link-url").html(node.link||"http://");
                    }
                } else {
                    refreshOrphanedWidgets();
                    if (listElements[node.id]) {
                        if (node.group != elementParents[node.id]) {
                            // Moved to a different group
                            if (groupLists[elementParents[node.id]]) {
                                groupLists[elementParents[node.id]].editableList('removeItem',listElements[node.id].data('data'))
                            }
                            if (groupLists[node.group]) {
                                groupLists[node.group].editableList('addItem',node);
                            }
                        } else {
                            var l = node._def.label;
                            try {
                                l = (typeof l === "function" ? l.call(node) : l)||"";
                            } catch(err) {
                                console.log("Definition error: "+d.type+".label",err);
                                l = d.type;
                            }
                            listElements[node.id].children(".nr-db-sb-list-header").find(".nr-db-sb-title").html(l);
                        }
                    } else {
                        if (groupLists[node.group]) {
                            groupLists[node.group].editableList('addItem',node)
                        }
                    }
                }
            }
        });

        var pendingAdd = [];
        var pendingAddTimer = null;

        function handlePendingAdds() {
            var hasTabs = false;
            var hasGroups = false;
            pendingAdd.sort(function(A,B) {
                hasTabs = hasTabs || A.type === "ui_tab" || B.type === "ui_tab";
                hasGroups = hasGroups || A.type === "ui_group" || B.type === "ui_group";
                if (A.type === B.type) {
                    return 0;
                }
                if (A.type === "ui_tab") {
                    return -1;
                } else if (B.type === "ui_tab") {
                    return 1;
                } else if (A.type === "ui_group") {
                    return -1;
                } else if (B.type === "ui_group") {
                    return 1;
                }
                return 0
            });
            for (var i=0;i<pendingAdd.length;i++) {
                var node = pendingAdd[i];
                if (node.type === "ui_tab") {
                    tabContainer.editableList('addItem',{node:node,groups:[]});
                } else {
                    if (hasTabs) {
                        // We've added some tabs, need to give jquery time to add the lists
                        pendingAdd = pendingAdd.slice(i);
                        pendingAddTimer = setTimeout(handlePendingAdds,50);
                        return;
                    }
                    if (node.type === "ui_group") {
                        if (tabLists[node.tab]) {
                            tabLists[node.tab].editableList('addItem',{node:node,widgets:[]});
                        }
                    } else {
                        if (hasGroups) {
                            // We've added some tabs, need to give jquery time to add the lists
                            pendingAdd = pendingAdd.slice(i);
                            pendingAddTimer = setTimeout(handlePendingAdds,50);
                            return;
                        }
                        if (groupLists[node.group]) {
                            groupLists[node.group].editableList('addItem',node)
                        } else {
                            refreshOrphanedWidgets();
                        }
                    }
                }
            }
            pendingAdd = [];
        }

        RED.events.on("nodes:add", function(node) {
            if (/^ui_/.test(node.type) && !listElements[node.id]) {
                pendingAdd.push(node);
                clearTimeout(pendingAddTimer);
                pendingAddTimer = setTimeout(handlePendingAdds,100);
            }
        });
        RED.events.on("nodes:remove", function(node) {
            if (/^ui_/.test(node.type)) {
                if (node.type === "ui_tab") {
                    if (listElements[node.id]) {
                        tabContainer.editableList('removeItem',listElements[node.id].data('data'));
                        delete tabLists[node.id];
                    }
                } else if (node.type === "ui_group") {
                    if (tabLists[node.tab] && listElements[node.id]) {
                        tabLists[node.tab].editableList('removeItem',listElements[node.id].data('data'));
                    }
                    delete groupLists[node.id];
                } else if (node.type === 'ui_link') {
                    if (linkNodes[node.id]) {
                        linksContainer.editableList('removeItem',linkNodes[node.id].data('data'));
                        delete linkNodes[node.id];
                    }
                } else {
                    if (groupLists[node.group]) {
                        groupLists[node.group].editableList('removeItem',node)
                    }
                }
                refreshOrphanedWidgets();
                delete listElements[node.id];
            }
        })
    }
});

(function($) {
    $.widget( "nodereddashboard.elementSizer", {
        _create: function() {
            var that = this;
            var gridWidth = 6;
            var width = parseInt($(this.options.width).val()||0);
            var height = parseInt(this.options.hasOwnProperty('height')?$(this.options.height).val():"1")||0;
            var hasAuto = (!this.options.hasOwnProperty('auto') || this.options.auto);

            this.element.css({
                minWidth: this.element.height()+4
            });
            var sizeLabel = (width === 0 && height === 0)?"auto":width+(this.options.hasOwnProperty('height')?" x "+height:"");
            this.element.html(sizeLabel).on('mousedown',function(evt) {
                evt.stopPropagation();
                evt.preventDefault();

                var width = parseInt($(that.options.width).val()||0);
                var height = parseInt(that.options.hasOwnProperty('height')?$(that.options.height).val():"1")||0;
                var maxWidth = 0;
                var maxHeight;
                var fixedWidth = false;
                var fixedHeight = false;
                var group = $(that.options.group).val();
                if (group) {
                    var groupNode = RED.nodes.node(group);
                    if (groupNode) {
                        gridWidth = Math.max(6,groupNode.width,+width);
                        maxWidth = groupNode.width || gridWidth;
                        fixedWidth = true;
                    }
                    maxHeight = Math.max(6,+height+1);
                } else {
                    gridWidth = Math.max(12,+width);
                    maxWidth = gridWidth;
                    maxHeight = 1;
                    fixedHeight = true;
                }

                var pos = $(this).offset();
                var container = $('<div>').css({
                    position: 'absolute',
                    background: 'white',
                    padding: '5px 10px 10px 10px',
                    border: '1px solid grey',
                    zIndex: '20',
                    borderRadius: "4px",
                    display:"none"
                }).appendTo(document.body);
                var closeTimer;

                container.on('mouseleave',function(evt) {
                    closeTimer = setTimeout(function() {
                        container.fadeOut(200, function() { $(this).remove(); });
                    },100)
                });
                container.on('mouseenter',function() {
                    clearTimeout(closeTimer);
                })

                var label = $("<div>").css({
                    fontSize: '13px',
                    color: '#aaa',
                    float: 'left',
                    paddingTop: '1px'
                }).appendTo(container).html((width === 0 && height === 0)?"auto":(width+(that.options.hasOwnProperty('height')?" x "+height:"")));

                var buttonRow = $('<div>',{style:"text-align:right; height: 25px;"}).appendTo(container);

                if (hasAuto) {
                    var button = $('<a>',{href:"#",class:"editor-button editor-button-small",style:"margin-bottom: 5px"})
                        .html("auto")
                        .appendTo(buttonRow)
                        .on('mouseup',function(evt) {
                            that.element.html("auto")
                            $(that.options.width).val(0).change();
                            $(that.options.height).val(0).change();
                            evt.preventDefault();
                            container.fadeOut(200, function() { $(this).remove(); });
                        });
                }

                var cellBorder = "1px dashed lightGray";
                var cellBorderExisting = "1px solid gray";
                var cellBorderHighlight = "1px dashed black";
                var rows = [];
                function addRow(i) {
                    var row = $('<div>').css({padding:0,margin:0,height:"25px","box-sizing":"border-box"}).appendTo(container);
                    rows.push(row);
                    cells.push([])
                    for (var j=0;j<gridWidth;j++) {
                        addCell(i,j);
                    }
                }
                function addCell(i,j) {
                    var row = rows[i];
                    var cell = $('<div>').css({
                        display:"inline-block",
                        width: "25px",
                        height: "25px",
                        borderRight: (j===(width-1)&&i<height)?cellBorderExisting:cellBorder,
                        borderBottom: (i===(height-1)&&j<width)?cellBorderExisting:cellBorder,
                        boxSizing: "border-box",
                        cursor:"pointer",
                        background: (j<maxWidth)?"#fff":"#eee"
                    }).appendTo(row);
                    cells[i].push(cell);
                    if (j===0) {
                        cell.css({borderLeft:((i<=height-1)?cellBorderExisting:cellBorder)});
                    }
                    if (i===0) {
                        cell.css({borderTop:((j<=width-1)?cellBorderExisting:cellBorder)});
                    }
                    if (j<maxWidth) {
                        cell.data("w",j);
                        cell.data("h",i);
                        cell.on("mouseup",function() {
                            that.element.html(($(this).data("w")+1)+(that.options.hasOwnProperty('height')?" x "+($(this).data("h")+1):""))
                            $(that.options.width).val($(this).data("w")+1).change();
                            $(that.options.height).val($(this).data("h")+1).change();
                            container.fadeOut(200, function() { $(this).remove(); });
                        });
                        cell.on("mouseover",function() {
                            var w = $(this).data("w");
                            var h = $(this).data("h");
                            label.html((w+1)+(that.options.hasOwnProperty('height')?" x "+(h+1):""));
                            for (var y = 0;y<maxHeight;y++) {
                                for (var x = 0;x<maxWidth;x++) {
                                    cells[y][x].css({
                                        background: (y<=h && x<=w)?'#ddd':'#fff',
                                        borderLeft: (x===0&&y<=h)?cellBorderHighlight:(x===0)?((y<=height-1)?cellBorderExisting:cellBorder):'',
                                        borderTop: (y===0&&x<=w)?cellBorderHighlight:(y===0)?((x<=width-1)?cellBorderExisting:cellBorder):'',
                                        borderRight: (x===w&&y<=h)?cellBorderHighlight:((x===width-1&&y<=height-1)?cellBorderExisting:cellBorder),
                                        borderBottom: (y===h&&x<=w)?cellBorderHighlight:((y===height-1&&x<=width-1)?cellBorderExisting:cellBorder)
                                    })
                                }
                            }
                            if (!fixedHeight && h === maxHeight-1) {
                                addRow(maxHeight++)
                            }
                            if (!fixedWidth && w === maxWidth-1) {
                                maxWidth++;
                                gridWidth++;
                                for (var r=0;r<maxHeight;r++) {
                                    addCell(r,maxWidth-1);
                                }
                            }
                        })
                    }
                }

                var cells = [];
                for (var i=0;i<maxHeight;i++) {
                    addRow(i);
                }
                container.css({
                    top:(pos.top)+"px",
                    left:(pos.left)+"px"
                });
                container.fadeIn(200);
            })
        }
    });
})(jQuery);
</script>

<script type="text/x-red" data-template-name="ui_base">
<div class='form-row'>
    <a href="#" onclick="RED.sidebar.show('dashboard'); $('#node-config-dialog-cancel').click(); return false" class="editor-button">Open dashboard sidebar</a>
</div>
</script>

<script type="text/x-red" data-help-name="ui_base">
</script>
